<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kafka WebSocket Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        .chat-container {
            width: 400px;
            margin: auto;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        .message {
            padding: 5px 10px;
            border-radius: 10px;
            margin: 5px;
            max-width: 70%;
        }
        .my-message {
            align-self: flex-end;
            background-color: #dcf8c6;
        }
        .other-message {
            align-self: flex-start;
            background-color: #f1f0f0;
        }
    </style>
</head>
<body>

<h1>Kafka WebSocket Chat</h1>

<!-- âœ… ì‚¬ìš©ì ID ì…ë ¥ -->
<label for="senderId">Your ID:</label>
<input type="text" id="senderId" value="user1" required>
<br>

<!-- âœ… ì±„íŒ…ë°© ID ì…ë ¥ -->
<label for="chatroomId">Chatroom ID:</label>
<input type="text" id="chatroomId" value="123" required>
<br>

<!-- âœ… ë©”ì‹œì§€ ì…ë ¥ í¼ -->
<input type="text" id="messageInput" placeholder="Enter message" required>
<button onclick="sendMessage()">Send</button>

<!-- âœ… ì±„íŒ… ë©”ì‹œì§€ë¥¼ í‘œì‹œí•  ì˜ì—­ -->
<h2>Messages:</h2>
<div class="chat-container" id="messageContainer"></div>

<script>
    let stompClient = null;
    let senderId = document.getElementById("senderId").value;
    let chatroomId = document.getElementById("chatroomId").value;

    // âœ… WebSocket ì—°ê²° ì„¤ì •
    function connect(retryCount = 3) {
        let socket = new SockJS('/ws');  // Spring Bootì—ì„œ ì„¤ì •í•œ WebSocket ì—”ë“œí¬ì¸íŠ¸
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('âœ… [WebSocket] Connected: ' + frame);

            stompClient.subscribe(`/topic/chat/${chatroomId}`, function (message) {
                console.log("ğŸ“¡ [WebSocket] Received message:", message.body);
                let msg = JSON.parse(message.body);
                showMessage(msg);
            });

        }, function (error) {
            console.error("âŒ [WebSocket] Connection Error:", error);
            if (retryCount > 0) {
                console.log(`ğŸ”„ [WebSocket] Retrying connection... (${retryCount} attempts left)`);
                setTimeout(() => connect(retryCount - 1), 3000);  // 3ì´ˆ í›„ ì¬ì‹œë„
            } else {
                console.error("âŒ [WebSocket] Connection failed after multiple attempts.");
            }
        });
    }

    // âœ… ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
    function sendMessage() {
        let messageContent = document.getElementById("messageInput").value;
        senderId = document.getElementById("senderId").value;
        chatroomId = document.getElementById("chatroomId").value;

        if (stompClient && messageContent.trim() !== "") {
            let message = {
                sender: senderId,
                content: messageContent,
                chatroomId: chatroomId

            };

            console.log("ğŸš€ [WebSocket] Sending message:", message);

            stompClient.send(`/api/v1/chat/sendMessage`, {}, JSON.stringify(message));
            document.getElementById("messageInput").value = "";
        } else {
            console.error("âŒ [WebSocket] Stomp client not connected or empty message.");
        }
    }

    // âœ… í™”ë©´ì— ë©”ì‹œì§€ ì¶”ê°€
    function showMessage(message) {
        let messageContainer = document.getElementById("messageContainer");
        let newMessage = document.createElement("div");

        newMessage.textContent = `${message.sender}: ${message.content}`;
        newMessage.classList.add("message");

        // âœ… ë³¸ì¸ì´ ë³´ë‚¸ ë©”ì‹œì§€ì™€ ë°›ì€ ë©”ì‹œì§€ êµ¬ë¶„
        if (message.sender === senderId) {
            newMessage.classList.add("my-message");
        } else {
            newMessage.classList.add("other-message");
        }

        messageContainer.appendChild(newMessage);
        messageContainer.scrollTop = messageContainer.scrollHeight; // ìë™ ìŠ¤í¬ë¡¤
    }

    // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ WebSocket ì—°ê²°
    connect();
</script>

</body>
</html>