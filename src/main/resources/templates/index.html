<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kafka WebSocket Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        .chat-container {
            width: 400px;
            margin: auto;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        .message {
            padding: 5px 10px;
            border-radius: 10px;
            margin: 5px;
            max-width: 70%;
        }
        .my-message {
            align-self: flex-end;
            background-color: #dcf8c6;
        }
        .other-message {
            align-self: flex-start;
            background-color: #f1f0f0;
        }
        /* Load More ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì±„íŒ…ì°½ ìœ„ì— ë°°ì¹˜) */
        #loadMoreButton {
            display: block;
            margin: 10px auto;
            padding: 5px 10px;
            cursor: pointer;
        }
        /* Disconnect ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #disconnectButton {
            display: block;
            margin: 10px auto;
            padding: 5px 10px;
            cursor: pointer;
            background-color: #f44336;
            color: #fff;
            border: none;
            border-radius: 5px;
        }
    </style>
</head>
<body>

<h1>Let's Chatting</h1>

<!-- âœ… ì‚¬ìš©ì ID ì…ë ¥ -->
<label for="senderId">Your ID:</label>
<input type="text" id="senderId" value="user1" required>
<br>

<!-- âœ… ì±„íŒ…ë°© ID ì…ë ¥ -->
<label for="chatroomId">Chatroom ID:</label>
<input type="text" id="chatroomId" value="123" required>
<br>

<!-- âœ… ë©”ì‹œì§€ ì…ë ¥ í¼ -->
<input type="text" id="messageInput" placeholder="Enter message" required>
<button id="sendButton" onclick="sendMessage()">Send</button>

<!-- âœ… Load More ë²„íŠ¼ (ì´ì „ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°) -->
<button id="loadMoreButton" onclick="loadOlderMessages()">Load More</button>

<!-- âœ… Disconnect ë²„íŠ¼ (WebSocket ì—°ê²° í•´ì œ) -->
<button id="disconnectButton" onclick="disconnectWebSocket()">Disconnect</button>

<!-- âœ… ì±„íŒ… ë©”ì‹œì§€ë¥¼ í‘œì‹œí•  ì˜ì—­ -->
<h2>Messages:</h2>
<div class="chat-container" id="messageContainer"></div>

<button onclick="window.location.href='/search'">Go to Search</button>

<!-- âœ… íŒŒì¼ ì„ íƒ ë° ì—…ë¡œë“œ ë²„íŠ¼ -->
<input type="file" id="fileInput" style="display: none;" onchange="uploadFile()" />
<button id="fileUploadButton" onclick="document.getElementById('fileInput').click();">
    Upload File
</button>


<script>
    document.getElementById("messageInput").addEventListener("keydown", function(event) {
        if (event.key === "Enter" && !event.isComposing) {  // í•œê¸€ ì…ë ¥ ì¤‘ì¼ ë•Œ ì‹¤í–‰ ë°©ì§€
            event.preventDefault();
            sendMessage();
        }
    });

    let stompClient = null;
    let senderId = document.getElementById("senderId").value;
    let chatroomId = document.getElementById("chatroomId").value;

    // í˜ì´ì§• ê´€ë ¨ ë³€ìˆ˜
    let currentPage = 0;
    const pageSize = 50;
    let totalPages = 1; // ì„œë²„ë¡œë¶€í„° ë°›ì€ totalPages ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸

    // âœ… WebSocket ì—°ê²° ì„¤ì •
    function connect(retryCount = 3) {
        let socket = new SockJS('/ws');  // Spring Bootì—ì„œ ì„¤ì •í•œ WebSocket ì—”ë“œí¬ì¸íŠ¸
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('âœ… [WebSocket] Connected: ' + frame);

            // âœ… ì´ˆê¸° ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ê°€ì¥ ìµœì‹  í˜ì´ì§€, ì¦‰ page=0)
            loadChatHistory(0);

            stompClient.subscribe(`/topic/chat/${chatroomId}`, function (message) {
                console.log("ğŸ“¡ [WebSocket] Received message:", message.body);
                let msg = JSON.parse(message.body);
                showMessage(msg); // ì‹ ê·œ ë©”ì‹œì§€ëŠ” í•˜ë‹¨ì— ì¶”ê°€
                scrollToBottom();
            });
        }, function (error) {
            console.error("âŒ [WebSocket] Connection Error:", error);
            if (retryCount > 0) {
                console.log(`ğŸ”„ [WebSocket] Retrying connection... (${retryCount} attempts left)`);
                setTimeout(() => connect(retryCount - 1), 3000);  // 3ì´ˆ í›„ ì¬ì‹œë„
            } else {
                console.error("âŒ [WebSocket] Connection failed after multiple attempts.");
            }
        });
    }

    // âœ… ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
    function sendMessage() {
        let messageContent = document.getElementById("messageInput").value;
        senderId = document.getElementById("senderId").value;
        chatroomId = document.getElementById("chatroomId").value;

        if (stompClient && messageContent.trim() !== "") {
            let now = new Date(); // âœ… í˜„ì¬ ì‹œê°„ ì¶”ê°€
            let timestamp = now.toISOString(); // âœ… ISO í˜•ì‹ (ì„œë²„ì—ì„œë„ ì¼ê´€ì„± ìœ ì§€)

            let message = {
                sender: senderId,
                content: messageContent,
                chatroomId: chatroomId,
                timestamp: timestamp  // âœ… ì„œë²„ì— ì „ì†¡í•  ë•Œ ì‹œê°„ í¬í•¨
            };

            console.log("ğŸš€ [WebSocket] Sending message:", message);
            stompClient.send(`/api/v1/chat/sendMessage`, {}, JSON.stringify(message));

            document.getElementById("messageInput").value = "";
        } else {
            console.error("âŒ [WebSocket] Stomp client not connected or empty message.");
        }
    }

    // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ ìˆ˜ì •
    function showMessage(message) {
        let messageContainer = document.getElementById("messageContainer");
        let newMessage = document.createElement("div");
        newMessage.classList.add("message");

        if (message.sender === senderId) {
            newMessage.classList.add("my-message");
        } else {
            newMessage.classList.add("other-message");
        }

        // âœ… ì‹œê°„ í‘œì‹œ (ì˜¤ë¥¸ìª½ ì•„ë˜ ì‘ì€ ê¸€ì”¨)
        let timestamp = message.timestamp ? formatTimestamp(message.timestamp) : "";
        let timestampElement = `<span class="timestamp" style="font-size: 10px; color: gray; margin-left: 8px;">${timestamp}</span>`;

        // âœ… íŒŒì¼ ë©”ì‹œì§€ì¸ ê²½ìš°
        if (message.fileUrl) {  // ğŸ“Œ `fileUrl` ì¡´ì¬ ì—¬ë¶€ ì²´í¬
            let fileName = message.content.replace("[íŒŒì¼] ", "");
            newMessage.innerHTML = `
            ${message.sender}:
            <a href="${message.fileUrl}" class="file-link" onclick="downloadFile(event, '${message.fileUrl}')">
                ğŸ“ ${fileName}
            </a> ${timestampElement}
        `;
        } else {
            newMessage.innerHTML = `
            ${message.sender}: ${message.content} ${timestampElement}
        `;
        }

        messageContainer.appendChild(newMessage);
        scrollToBottom();
    }

    // âœ… ìŠ¤í¬ë¡¤ì„ ì±„íŒ…ì°½ ë§¨ ì•„ë˜ë¡œ ì´ë™
    function scrollToBottom() {
        let messageContainer = document.getElementById("messageContainer");
        messageContainer.scrollTop = messageContainer.scrollHeight;
    }

    // âœ… ì±„íŒ… ê¸°ë¡ì„ í˜ì´ì§•ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
    function loadChatHistory(page) {
        fetch(`/history/${chatroomId}?page=${page}&size=${pageSize}`)
            .then(response => response.json())
            .then(data => {
                let messages = data.content;

                if (page === 0) {
                    // ì´ˆê¸° ë¡œë”© ì‹œ ìµœì‹  ë©”ì‹œì§€ê°€ ë‚´ë ¤ì˜¤ëŠ” ìˆœì„œëŒ€ë¡œ append (reverse X)
                    messages.forEach(msg => showMessage(msg));
                    scrollToBottom();
                } else {
                    // "Load More" ì‹œ: prependí•˜ì—¬ ê¸°ì¡´ ë©”ì‹œì§€ ìœ„ì— ì¶”ê°€
                    messages.reverse().forEach(msg => prependMessage(msg));
                }

                totalPages = data.totalPages;
                currentPage = page;

                if (currentPage + 1 >= totalPages) {
                    document.getElementById("loadMoreButton").style.display = "none";
                }
            })
            .catch(error => console.error("âŒ Failed to load chat history:", error));
    }

    // âœ… Load More ë²„íŠ¼ í´ë¦­ ì‹œ ì´ì „ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° (ë‹¤ìŒ í˜ì´ì§€)
    function loadOlderMessages() {
        let nextPage = currentPage + 1;
        if (nextPage < totalPages) {
            loadChatHistory(nextPage);
        }
    }

    // âœ… WebSocket ì—°ê²° í•´ì œ í›„ í˜ì´ì§€ ì´ë™ í•¨ìˆ˜
    function disconnectWebSocket() {
        if (stompClient) {
            stompClient.disconnect(() => {
                console.log("ì›¹ì†Œì¼“ ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                // ì—°ê²° í•´ì œ í›„ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë§¤í•‘í•œ /disconnected í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = "/disconnected";
            });
        } else {
            window.location.href = "/disconnected";
        }
    }
    // âœ… íŒŒì¼ ì—…ë¡œë“œ í•¨ìˆ˜ (íŒŒì¼ ì œëª©ë§Œ í‘œì‹œ, í´ë¦­í•˜ë©´ ë‹¤ìš´ë¡œë“œ)
    function uploadFile() {
        let fileInput = document.getElementById("fileInput");
        let file = fileInput.files[0];
        let senderId = document.getElementById("senderId").value;
        let chatroomId = document.getElementById("chatroomId").value;

        if (!file) {
            alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
            return;
        }

        let formData = new FormData();
        formData.append("file", file);
        formData.append("sender", senderId);
        formData.append("chatroomId", chatroomId);
        formData.append("content", `[íŒŒì¼] ${file.name}`);

        fetch("/save/file", {
            method: "POST",
            body: formData
        })
            .then(response => {
                if (!response.ok) throw new Error("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨");
                return response.json();
            })
            .then(data => {
                console.log("âœ… íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ, ì„œë²„ì—ì„œ WebSocketìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡ë¨:", data);
            })
            .catch(error => {
                console.error("íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:", error);
                alert("íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
    }

    // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬ í•¨ìˆ˜
    function downloadFile(event, fileUrl) {
        event.preventDefault();

        fetch(`/download?fileUrl=${encodeURIComponent(fileUrl)}`)
            .then(response => response.json())
            .then(data => {
                if (data.url) {
                    window.location.href = data.url; // âœ… Presigned URLë¡œ ë°”ë¡œ ì´ë™í•˜ì—¬ ë‹¤ìš´ë¡œë“œ
                } else {
                    throw new Error("ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„± ì‹¤íŒ¨");
                }
            })
            .catch(error => {
                console.error("íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:", error);
                alert("íŒŒì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
    }

    // âœ… ì´ì „ ë©”ì‹œì§€ë¥¼ í™”ë©´ ìƒë‹¨ì— ì¶”ê°€ (ì—­ìˆœ ì •ë ¬ ë°©ì§€)
    function prependMessage(message) {
        let messageContainer = document.getElementById("messageContainer");
        let newMessage = document.createElement("div");
        newMessage.classList.add("message");

        if (message.sender === senderId) {
            newMessage.classList.add("my-message");
        } else {
            newMessage.classList.add("other-message");
        }

        // âœ… ì‹œê°„ ì¶”ê°€ (ì´ì „ ì±„íŒ…ë„ ë™ì¼í•˜ê²Œ ì ìš©)
        let timestamp = message.timestamp ? formatTimestamp(message.timestamp) : "";
        let timestampElement = `<span class="timestamp" style="font-size: 10px; color: gray; margin-left: 8px;">${timestamp}</span>`;

        if (message.content.startsWith("[íŒŒì¼]")) {
            let fileName = message.content.replace("[íŒŒì¼] ", "");
            newMessage.innerHTML = `
            ${message.sender}:
            <a href="#" class="file-link" onclick="downloadFile(event, '${fileName}')">
                ğŸ“ ${fileName}
            </a> ${timestampElement}
        `;
        } else {
            newMessage.innerHTML = `
            ${message.sender}: ${message.content} ${timestampElement}
        `;
        }

        // âœ… ê³¼ê±° ë©”ì‹œì§€ëŠ” "ë§¨ ìœ„"ì— ì¶”ê°€í•˜ì—¬ ìˆœì„œ ìœ ì§€
        messageContainer.insertBefore(newMessage, messageContainer.firstChild);
    }


    // ì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜
    function formatTimestamp(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        return date.toLocaleTimeString();
    }

    // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ WebSocket ì—°ê²°
    connect();
</script>

</body>
</html>