<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kafka WebSocket Chat</title>
    <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        /* ê¸°ë³¸ ë¦¬ì…‹ */
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        /* ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .chat-container {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            border: 1px solid #ddd;
            background-color: #fff;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        .message {
            padding: 8px 12px;
            border-radius: 8px;
            margin: 5px 0;
            word-wrap: break-word;
            font-size: 14px;
        }
        .my-message {
            align-self: flex-end;
            background-color: #dcf8c6;
        }
        .other-message {
            align-self: flex-start;
            background-color: #f1f0f0;
        }
        .timestamp {
            font-size: 10px;
            color: #999;
            margin-left: 8px;
        }
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button {
            display: inline-block;
            margin: 10px 5px;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        #sendButton {
            background-color: #4caf50;
            color: #fff;
        }
        #sendButton:hover {
            background-color: #45a049;
        }
        #loadMoreButton {
            background-color: #008cba;
            color: #fff;
        }
        #loadMoreButton:hover {
            background-color: #007bb5;
        }
        #disconnectButton {
            background-color: #f44336;
            color: #fff;
        }
        #disconnectButton:hover {
            background-color: #da190b;
        }
        /* í¼ ìŠ¤íƒ€ì¼ */
        .input-group {
            width: 100%;
            max-width: 600px;
            margin: 10px auto;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .input-group label {
            flex: 0 0 100%;
            font-weight: bold;
            color: #555;
        }
        .input-group input {
            flex: 1;
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<h1>Let's Chatting</h1>

<!-- ì‚¬ìš©ì ì…ë ¥ í¼ -->
<div class="input-group">
    <label for="senderId">Your ID:</label>
    <input type="text" id="senderId" value="user1" required>
</div>
<div class="input-group">
    <label for="chatroomId">Chatroom ID:</label>
    <input type="text" id="chatroomId" value="123" required>
</div>
<div class="input-group">
    <input type="text" id="messageInput" placeholder="Enter message" required>
    <button id="sendButton" onclick="sendMessage()">Send</button>
</div>

<!-- ì¶”ê°€ ë²„íŠ¼ë“¤ -->
<div class="input-group" style="justify-content: center;">
    <button id="loadMoreButton" onclick="loadOlderMessages()">Load More</button>
    <button id="disconnectButton" onclick="disconnectWebSocket()">Disconnect</button>
    <button onclick="window.location.href='/search'">Go to Search</button>
    <button id="fileUploadButton" onclick="document.getElementById('fileInput').click();">Upload File</button>
    <input type="file" id="fileInput" style="display: none;" onchange="uploadFile()" />
</div>

<!-- ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
<div class="chat-container" id="messageContainer"></div>

<script>
    let stompClient = null;
    let senderId = document.getElementById("senderId").value;
    let chatroomId = document.getElementById("chatroomId").value;

    // í˜ì´ì§• ê´€ë ¨ ë³€ìˆ˜
    let lastMessageId = null;  // ë§ˆì§€ë§‰ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¨ ë©”ì‹œì§€ ID (ì»¤ì„œ)
    const pageSize = 100;
    let hasMoreMessages = true;  // ì¶”ê°€ ë©”ì‹œì§€ê°€ ìˆëŠ”ì§€ ì—¬ë¶€

    // WebSocket ì—°ê²° ì„¤ì •
    function connect(retryCount = 3) {
        let socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('âœ… [WebSocket] Connected: ' + frame);
            loadChatHistory(); // ìµœì´ˆ ì±„íŒ… ê¸°ë¡ ë¡œë“œ

            stompClient.subscribe(`/topic/chat/${chatroomId}`, function (message) {
                console.log("ğŸ“¡ [WebSocket] Received message:", message.body);
                let msg = JSON.parse(message.body);
                showMessage(msg); // ì‹ ê·œ ë©”ì‹œì§€ëŠ” í•˜ë‹¨ì— ì¶”ê°€
                scrollToBottom();
            });
        }, function (error) {
            console.error("âŒ [WebSocket] Connection Error:", error);
            if (retryCount > 0) {
                console.log(`ğŸ”„ Retrying WebSocket connection (${retryCount} attempts left)`);
                setTimeout(() => connect(retryCount - 1), 3000);
            } else {
                console.error("âŒ Connection failed after multiple attempts.");
            }
        });
    }

    // ë©”ì‹œì§€ ì „ì†¡
    function sendMessage() {
        let messageContent = document.getElementById("messageInput").value;
        senderId = document.getElementById("senderId").value;
        chatroomId = document.getElementById("chatroomId").value;

        if (stompClient && messageContent.trim() !== "") {
            let now = new Date();
            let timestamp = now.toISOString();

            let message = {
                sender: senderId,
                content: messageContent,
                chatroomId: chatroomId,
                timestamp: timestamp
            };

            console.log("ğŸš€ Sending message:", message);
            stompClient.send(`/api/v1/chat/sendMessage`, {}, JSON.stringify(message));

            showMessage(message);
            scrollToBottom();

            document.getElementById("messageInput").value = "";
        } else {
            console.error("âŒ Stomp client not connected or empty message.");
        }
    }

    // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showMessage(message) {
        let messageContainer = document.getElementById("messageContainer");
        let newMessage = document.createElement("div");
        newMessage.classList.add("message");

        if (message.sender === senderId) {
            newMessage.classList.add("my-message");
        } else {
            newMessage.classList.add("other-message");
        }

        let timestamp = message.timestamp ? formatTimestamp(message.timestamp) : "";
        let timestampElement = `<span class="timestamp">${timestamp}</span>`;

        newMessage.innerHTML = `${message.sender}: ${message.content} ${timestampElement}`;
        messageContainer.appendChild(newMessage);
        scrollToBottom();
    }

    // ì´ì „ ë©”ì‹œì§€ ë¡œë“œ ì‹œ prepend
    function prependMessage(message) {
        let messageContainer = document.getElementById("messageContainer");
        let newMessage = document.createElement("div");
        newMessage.classList.add("message");

        if (message.sender === senderId) {
            newMessage.classList.add("my-message");
        } else {
            newMessage.classList.add("other-message");
        }

        let timestamp = message.timestamp ? formatTimestamp(message.timestamp) : "";
        let timestampElement = `<span class="timestamp">${timestamp}</span>`;

        newMessage.innerHTML = `${message.sender}: ${message.content} ${timestampElement}`;
        messageContainer.insertBefore(newMessage, messageContainer.firstChild);
    }

    // ìŠ¤í¬ë¡¤ ë§¨ ì•„ë˜ë¡œ ì´ë™
    function scrollToBottom() {
        let messageContainer = document.getElementById("messageContainer");
        messageContainer.scrollTop = messageContainer.scrollHeight;
    }

    // ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ìµœì‹  ë©”ì‹œì§€ 100ê°œ)
    function loadChatHistory() {
        let url = lastMessageId
            ? `/history2/cursor/123?lastMessageId=${lastMessageId}&size=${pageSize}`
            : `/history2/cursor/123?size=${pageSize}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                console.log("ğŸ” ì„œë²„ ì‘ë‹µ ë°ì´í„°:", data);
                if (!data || !Array.isArray(data)) {
                    console.error("âŒ ì˜¬ë°”ë¥¸ ë°ì´í„°ê°€ ì•„ë‹˜!", data);
                    hasMoreMessages = false;
                    return;
                }

                let messages = data; // ë³€ê²½: data.content â†’ data
                if (messages.length === 0) {
                    hasMoreMessages = false;
                    return;
                }

                messages.reverse().forEach(msg => prependMessage(msg));

                // ìƒˆë¡œìš´ ì»¤ì„œ ì„¤ì • (ê°€ì¥ ì˜¤ë˜ëœ ë©”ì‹œì§€ ID)
                lastMessageId = messages[0].id;
            })
            .catch(error => console.error("âŒ Failed to load chat history:", error));
    }

    // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ìŠ¤í¬ë¡¤ì´ ë§¨ ìœ„ì— ë‹¿ìœ¼ë©´ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°)
    document.getElementById("messageContainer").addEventListener("scroll", function () {
        if (this.scrollTop === 0 && hasMoreMessages) {
            loadChatHistory();
        }
    });

    // ì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜
    function formatTimestamp(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        return date.toLocaleTimeString();
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ WebSocket ì—°ê²°
    connect();
</script>

</body>
</html>